# Create simulator
set ns [new Simulator]

# Trace files
set tr [open lab11.tr w]
$ns trace-all $tr

set nam [open lab11.nam w]
$ns namtrace-all $nam


# Finish procedure
proc finish {} {
    global ns tr nam

    $ns flush-trace
    close $tr
    close $nam

    exec nam lab11.nam &
    exec grep -c "^d" lab11.tr &

    exit 0
}


# Create 6 nodes
for {set i 0} {$i < 6} {incr i} {
    set n($i) [$ns node]
}


# Connect nodes in chain
for {set i 0} {$i < 5} {incr i} {
    $ns duplex-link $n($i) $n([expr $i+1]) 0.1Mb 10ms DropTail
}


# Small queue to create congestion
$ns queue-limit $n(2) $n(3) 2


# Ping agents
set p0 [new Agent/Ping]
set p1 [new Agent/Ping]

$ns attach-agent $n(0) $p0
$ns attach-agent $n(5) $p1

$ns connect $p0 $p1


# Heavy traffic to create congestion
set tcp [new Agent/TCP]
set sink [new Agent/TCPSink]

$ns attach-agent $n(2) $tcp
$ns attach-agent $n(4) $sink
$ns connect $tcp $sink

set cbr [new Application/Traffic/CBR]
$cbr set packetSize_ 500
$cbr set rate_ 1Mb
$cbr attach-agent $tcp


# Events
$ns at 0.2 "$p0 send"
$ns at 0.4 "$cbr start"
$ns at 1.4 "$cbr stop"
$ns at 1.6 "$p0 send"
$ns at 2.0 "finish"


# Run simulation
$ns run
